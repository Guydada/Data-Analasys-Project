---
title: "Global Trends of CO2 Emission and Effects on the Global Hapinnes Index"
subtitle: "Data Analysis Project - Digital Sciences for Hightech"
author:
- "Guy Krothammer, Yarden Katash, Guy Dahan"
output: 
  html_notebook:
    toc: true
    number_section: false
    fig_width: 10
    fig_height: 10
    fig_caption: true
    df_print: kable
    fontsize: 11pt
    theme: united
---

# Introduction

## Background

This project was done as a part of "Data Analysis" course as part of our teams 
studies in Digital Sciences for High-Tech in the University of Tel-Aviv. 
Our team has great interest in using our studies for exploring and in the future maybe even
developing tools for improving the way we treat our planet. Therefore our subject is
CO2 emissions in congestion with the world happinnes index. 

## Goals

1. Find the trends of CO2 emissions in different countries along the years 1700-2017.
2. Find what countries had greater growth in emissions and in which years.
3. Compare the leading countries with the highest recent trends of growth or decreased emission
in correlation with the current and previous UN happines Index. 

# Part 1: Importing Data and Packages

## Packages Import

```{r}

# install and import packages
install.packages("ggchicklet", repos = "https://cinc.rud.is") # for rounded corners 
install.packages("cowplot") #patch plots
install.packages("hrbrthemes", repos = c("https://cinc.rud.is", "https://cloud.r-project.org/")) #beautiful theme
install.packages("waffle", repos = "https://cinc.rud.is") #waffle plot
install.packages("ggalt") #dumbell plot
install.packages("GGally") # correlation matrix
install.packages
install.packages("Hmisc")# to install the relative weight package
remotes::install_github("martinctc/rwa") # relative weight analys

# import library
library(tidyverse) 
library(ggchicklet)
library(cowplot)
library(hrbrthemes)
library(ggalt)
library(GGally)
library(rwa)
library(readr)
library(Hmisc)
library(tibble)
```

## Data import

```{r}
happy_index_2005 <- "Data/world-happiness-report-2005-2020.csv" 
happy_index_2021 <- "Data/world-happiness-report-2021.csv"
emission <- "Data/co2_emission.csv" # TODO The headline isn't loaded well for column 4
population <-"Data/population.csv"

df_2005 <- read.csv(happy_index_2005)
df_2021 <- read.csv(happy_index_2021)
df_emiss <- read.csv(emission, col.names = c("Entity", "Code" , "Year", "co2"))
df_pop <- read.csv(population)

as_tibble(df_2005)
as_tibble(df_2021)
as_tibble(df_emiss)
as_tibble(df_pop)
```

As seen in the table above, the main dataset regarding emissions has only 4 features, of which 2 are identical (countries and country code). 


```{r}
summary(df_emiss)
```


# Part 2: Tidying the Data

## 

```{r}
filter(df_emiss, Year < 1950, preserve = FALSE) # TODO filter by year larger than 1950, fix code

df_emiss <-df_emiss %>% # add dif column
  group_by(Entity) %>%
  mutate(Diff = co2 - lag(co2, default = co2[1]))

df_pop_to_merge <- df_pop %>%
  filter(Year > 1949)

df_emiss_to_merge <- df_emiss %>%
  filter(Year > 1949)

df_emiss_to_merge$Entity <- as.character(df_emiss_to_merge$Entity)
df_pop_to_merge$Entity <- as.character(df_pop_to_merge$Entity)

library(dplyr)
df_all <- full_join(df_emiss_to_merge, df_pop_to_merge, by = c('Entity','Year'))

drops <- c("Code.y")
df_all <-df_all[, !(names(df_all) %in% drops)]

names(df_all)[names(df_all) == "Code.x"] <- "Code"

view(df_all)

#TODO add population by years to Df_emiss

df_emiss_above_1950 <- df_emiss %>% filter(Year >= 1950) # filtered by years larger than 1950
view(df_emiss_above_1950)

df_emiss <-df_emiss %>% # add dif column
  group_by(Entity) %>%
  mutate(Diff = co2 - lag(co2, default = co2[1]))
view(df_emiss)

df_skipping_by_10 <- df_emiss_above_1950 %>% slice(which(Year %% 10 == 0 | Year == 2017))
view(df_skipping_by_10)

df_emiss <- df_skipping_by_10 %>% # add 10 years dif column
  group_by(Entity) %>%
  mutate(Ten_years_Diff = co2 - lag(co2, default = co2[1]))
view(df_emiss)

df_emiss <- df_emiss %>% # TODO add 20 years dif column - not done.
  group_by(Entity) %>%
  mutate(Tewnty_years_Diff = co2 - lag(co2, default = co2[2]))
view(df_emiss)

#TODO qeevcolumn of normalised emission: co2/population by year


```

# Part 3: Proccesing of the Data

## Visualisation 

### 3.1 Single Country Emission Graph

```{r}
#TODO add dropbox to choose which country is shown (by HTML CODE)

df = filter(df_emiss, Entity == "United Kingdom")
g <- ggplot(data = df, aes(x = Year, y = co2, group = Entity) ) + 
    geom_line()
    
g <- g + labs(title = "United Kingdom Emissions in metric tons of CO2 by Years")
g
```

### 3.2 Happinness Trends in Single Country 

```{r}
#TODO maybe drop this later

colnames(df_2005)
names(df_2005)[1] <- "Entity"

df = filter(df_2005, Entity == "United Kingdom")
g <- ggplot(data = df, aes(x = year, y = Life.Ladder, group = Entity)) + 
    geom_line()
    
g <- g + labs(title = "Contries Hapinness by Years")
g

```

### 3.3

```{r}

```

### Year-on-year change in COâ‚‚ for Top 10 Countries

```{r}

top_emiss_2017 <- df_emiss %>%
  filter(Year == 2017) %>%
  filter(Code != '') %>%
  filter(Entity != "World") %>%
  top_n( 10, co2) %>%
  arrange(desc(co2)) %>%
  head(10)
  
top_countries = top_emiss_2017$Entity
```

```{r}

g <- ggplot(data = df, aes(x = year, y = Life.Ladder, group = Entity)) + 
    geom_line()
    
g <- g + labs(title = "Contries Hapinness by Years")
g
```


```{r}
g <- ggplot(data = df_emiss[df_emiss$Entity %in% top_countries, ] 
                          , aes(x = Year, y = co2, group = Entity)) + 
    geom_line()
g <- g + labs(title = "Top 10 Countries by CO2 Emissions")
g

df_emiss[df_emiss$Entity %in% top_countries, ] 
```


## Modelling

Our suggestions:
1. There is correlation between the total trend and current happiness index
2. There is correlation between current emission normalised by population to current hapinness index

```{r}


```


